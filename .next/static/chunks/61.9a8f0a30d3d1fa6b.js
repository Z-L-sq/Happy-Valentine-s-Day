"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[61],{2061:function(e,t,r){r.r(t),r.d(t,{default:function(){return p}});var l=r(7437),a=r(2265),n=r(4739),o=r(7633);function i(e,t){let r=e+4,l=e+n.ow-4,a=t+n.ow/2,o=t+n.ow+4;for(let e of[{x:r,y:a},{x:l,y:a},{x:r,y:o},{x:l,y:o},{x:(r+l)/2,y:o}])if(!function(e,t){let r=Math.floor(e/n.I_),l=Math.floor(t/n.I_);return!(r<0)&&!(r>=n.rj)&&!(l<0)&&!(l>=n.AV)&&1===n.Fu[l][r]}(e.x,e.y))return!0;return!1}function d(e,t){let r=e+n.ow/2,l=t+n.ow/2,a=null,o=1/0;for(let e of n.RV){let t=e.x*n.I_,i=(e.x+e.width)*n.I_,d=e.y*n.I_,s=(e.y+e.height)*n.I_,u=Math.max(t,Math.min(r,i)),c=Math.max(d,Math.min(l,s)),g=r-u,f=l-c,h=Math.sqrt(g*g+f*f);h<n.j5&&h<o&&(o=h,a=e)}return a}let s={[n.Nm.DOWN]:0,[n.Nm.LEFT]:1,[n.Nm.RIGHT]:2,[n.Nm.UP]:3},u=[0,1,0,2],c=Math.round(51.64102564102564);function g(e,t,r,l,a,o,i){if(!i){e.fillStyle="#FF8FAB",e.beginPath(),e.arc(t+n.ow/2,r+n.ow/2,n.ow/2,0,2*Math.PI),e.fill();return}e.save();let d=s[l],g=o?u[a%u.length]:0,f=t+n.ow/2-19,h=r+n.ow/2-c/2;e.drawImage(i,429*g,583*d,429,583,f,h,38,c),e.restore()}function f(e,t,r,l,a,n){e.beginPath(),e.moveTo(t+n,r),e.lineTo(t+l-n,r),e.quadraticCurveTo(t+l,r,t+l,r+n),e.lineTo(t+l,r+a-n),e.quadraticCurveTo(t+l,r+a,t+l-n,r+a),e.lineTo(t+n,r+a),e.quadraticCurveTo(t,r+a,t,r+a-n),e.lineTo(t,r+n),e.quadraticCurveTo(t,r,t+n,r),e.closePath()}var h=r(9055);function m(e){return new Promise(t=>{let r=new Image;r.onload=()=>t(r),r.onerror=()=>{console.warn("⚠️ 无法加载: ".concat(e)),t(null)},r.src=e})}function w(e,t,r,l,a){let n=document.createElement("canvas");n.width=t*l,n.height=r*l;let o=n.getContext("2d");return o.imageSmoothingEnabled=!1,a&&(o.fillStyle=a,o.fillRect(0,0,n.width,n.height)),e&&o.drawImage(e,0,0,e.width,e.height,0,0,n.width,n.height),n}async function y(e,t,r){let[l,a,n,o]=await Promise.all([m((0,h.u)("/sprites/background.png")),m((0,h.u)("/sprites/foreground.png")),m((0,h.u)("/sprites/frame.png")),m((0,h.u)("/sprites/player.png"))]);console.log("\uD83D\uDDBC️ 资源加载:",l?"✅ background.png":"❌ background.png",a?"✅ foreground.png":"❌ foreground.png",n?"✅ frame.png":"❌ frame.png",o?"✅ player.png":"❌ player.png");let i=w(l,e,t,r,"#050303"),d=w(a,e,t,r),s=w(n,e,t,r),u=function(e,t,r,l){let a=Array(r).fill(null),n=e.getContext("2d"),o=t*l;for(let e=0;e<r;e++){let t=e*l,r=n.getImageData(0,t,o,l),i=!1;for(let e=3;e<r.data.length;e+=4)if(r.data[e]>0){i=!0;break}if(!i)continue;let d=document.createElement("canvas");d.width=o,d.height=l;let s=d.getContext("2d");s.imageSmoothingEnabled=!1,s.putImageData(r,0,0),a[e]=d}let i=a.filter(Boolean).length;return console.log("✂️ 前景切片: ".concat(i,"/").concat(r," 行有内容")),a}(d,e,t,r);return{background:i,foreground:d,foregroundRows:u,frameOverlay:s,playerSprite:o,loaded:!0}}function p(){let e=(0,a.useRef)(null),t=(0,a.useRef)(new Set),r=(0,a.useRef)(0),s=(0,a.useRef)({background:null,foreground:null,foregroundRows:[],frameOverlay:null,playerSprite:null,loaded:!1}),[u,c]=(0,a.useState)(!0),h=o.g;(0,a.useEffect)(()=>{y(n.rj,n.AV,n.I_).then(e=>{s.current=e,c(!1),console.log("✅ 所有资源加载完毕, 背景已预渲染")})},[]),(0,a.useEffect)(()=>{let e=e=>{let r=e.key.toLowerCase();if(t.current.add(r),"e"===r&&!h.getState().activeModal){let e=d(h.getState().playerX,h.getState().playerY);e&&h.getState().openModal(e.type,e.id)}},r=e=>{t.current.delete(e.key.toLowerCase())};return window.addEventListener("keydown",e),window.addEventListener("keyup",r),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",r)}},[h]);let m=(0,a.useCallback)(()=>{var l,a,o;let u=e.current;if(!u)return;let c=u.getContext("2d");if(!c)return;let w=h.getState(),y=performance.now();if(!w.activeModal){let e=0,a=0,o=t.current;(o.has("w")||o.has("arrowup"))&&(a=-n.Vx,h.getState().setDirection(n.Nm.UP)),(o.has("s")||o.has("arrowdown"))&&(a=n.Vx,h.getState().setDirection(n.Nm.DOWN)),(o.has("a")||o.has("arrowleft"))&&(e=-n.Vx,h.getState().setDirection(n.Nm.LEFT)),(o.has("d")||o.has("arrowright"))&&(e=n.Vx,h.getState().setDirection(n.Nm.RIGHT)),0!==e&&0!==a&&(e*=.707,a*=.707);let s=0!==e||0!==a;if(h.getState().setIsMoving(s),s){let t=w.playerX+e,l=w.playerY+a,n=w.playerX,o=w.playerY;i(t,w.playerY)||(n=t),i(n,l)||(o=l),h.getState().movePlayer(n,o),r.current++,r.current%8==0&&h.getState().nextAnimFrame()}let u=d(h.getState().playerX,h.getState().playerY);h.getState().setNearbyObject(null!==(l=null==u?void 0:u.id)&&void 0!==l?l:null)}let p=h.getState(),v=s.current;if(c.clearRect(0,0,n.vj,n.lf),c.imageSmoothingEnabled=!1,(a=v.background)?c.drawImage(a,0,0):(c.fillStyle="#050303",c.fillRect(0,0,n.rj*n.I_,n.AV*n.I_)),!function(e,t,r){if(!t)return;let l=n.RV.find(e=>e.id===t);if(!l)return;let a=l.x*n.I_,o=l.y*n.I_,i=l.width*n.I_,d=l.height*n.I_,s=.3*Math.sin(.005*r)+.5;e.save(),e.strokeStyle="rgba(255, 215, 0, ".concat(s,")"),e.lineWidth=3,e.shadowColor="#FFD700",e.shadowBlur=12*s,e.strokeRect(a+1,o+1,i-2,d-2),e.restore()}(c,p.nearbyObject,y),!function(e,t,r,l,a,o,i,d){let s=l+n.ow,u=!1;for(let c=0;c<t.length;c++){let f=t[c],h=(c+1)*n.I_;!u&&h>s&&(g(e,r,l,a,o,i,d),u=!0),f&&e.drawImage(f,0,c*n.I_)}u||g(e,r,l,a,o,i,d)}(c,v.foregroundRows,p.playerX,p.playerY,p.direction,p.animFrame,p.isMoving,v.playerSprite),(o=v.frameOverlay)&&c.drawImage(o,0,0),p.nearbyObject&&!p.activeModal){let e=n.RV.find(e=>e.id===p.nearbyObject);e&&function(e,t,r,l,a){let n=r-24+3*Math.sin(.004*a),o="按 E — ".concat(l);e.save(),e.font='11px "Press Start 2P", monospace',e.textAlign="center";let i=e.measureText(o),d=i.width+20;e.fillStyle="rgba(0,0,0,0.9)",f(e,t-d/2,n-12,d,24,8),e.fill(),e.strokeStyle="#FFD700",e.lineWidth=2,f(e,t-d/2,n-12,d,24,8),e.stroke(),e.strokeStyle="rgba(255,215,0,0.3)",e.lineWidth=1,f(e,t-d/2+2,n-12+2,d-4,20,6),e.stroke(),e.fillStyle="rgba(0,0,0,0.9)",e.beginPath(),e.moveTo(t-6,n+12),e.lineTo(t,n+12+7),e.lineTo(t+6,n+12),e.closePath(),e.fill(),e.strokeStyle="#FFD700",e.lineWidth=2,e.beginPath(),e.moveTo(t-6,n+12),e.lineTo(t,n+12+7),e.lineTo(t+6,n+12),e.stroke(),e.fillStyle="#000000",e.textBaseline="middle",e.fillText(o,t+1,n+1),e.fillStyle="#FFFFFF",e.fillText(o,t,n),e.fillStyle="#FFD700",e.fillText("E",t-i.width/2+16,n),e.restore()}(c,p.playerX+n.ow/2,p.playerY-10,e.label,y)}!function(e,t){let r=e.canvas.width,l=e.canvas.height;e.fillStyle="rgba(255, 240, 200, 0.03)",e.fillRect(0,0,r,l);let a=e.createRadialGradient(r/2,l/2,.3*r,r/2,l/2,.7*r);a.addColorStop(0,"rgba(0,0,0,0)"),a.addColorStop(1,"rgba(0,0,0,0.12)"),e.fillStyle=a,e.fillRect(0,0,r,l)}(c,0),requestAnimationFrame(m)},[h]);return(0,a.useEffect)(()=>{let e=requestAnimationFrame(m);return()=>cancelAnimationFrame(e)},[m]),(0,l.jsxs)("div",{className:"relative",children:[(0,l.jsx)("canvas",{ref:e,width:n.vj,height:n.lf,className:"block border-4 border-sdv-dark rounded-lg shadow-2xl",style:{imageRendering:"pixelated",maxWidth:"100%",height:"auto"}}),u&&(0,l.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-sdv-dark/80 rounded-lg",children:(0,l.jsx)("div",{className:"text-center",children:(0,l.jsx)("p",{className:"font-pixel text-sdv-gold text-sm animate-sparkle",children:"\uD83D\uDDBC️ 加载精灵图..."})})})]})}}}]);